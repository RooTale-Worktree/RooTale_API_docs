openapi: 3.0.0
info:
  title: RooTale API
  version: 1.0.0
  description: |
    RooTale 프로젝트용 API 명세서
    인터랙티브 스토리텔링과 캐릭터 채팅을 위한 종합 API
  contact:
    name: RooTale Team
    email: support@rootale.com
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: https://api.rootale.com/v1
    description: Production server
  - url: https://staging-api.rootale.com/v1
    description: Staging server
  - url: http://localhost:3000/v1
    description: Development server

security:
  - BearerAuth: []

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT 액세스 토큰
  schemas:
    User:
      type: object
      properties:
        id:
          type: string
          format: uuid
          description: 사용자 고유 ID
        email:
          type: string
          format: email
          description: 이메일 주소
        username:
          type: string
          minLength: 3
          maxLength: 20
          description: 사용자명
        nickname:
          type: string
          maxLength: 30
          description: 닉네임
        avatar_url:
          type: string
          format: uri
          description: 프로필 이미지 URL
        provider:
          type: string
          enum: [KAKAO, NAVER, GOOGLE]
          description: 소셜 로그인 제공자
        provider_id:
          type: string
          description: 소셜 플랫폼에서의 사용자 ID
        created_at:
          type: string
          format: date-time
          description: 계정 생성일
        updated_at:
          type: string
          format: date-time
          description: 마지막 수정일
        is_active:
          type: boolean
          description: 계정 활성화 상태
        subscription_tier:
          type: string
          enum: [free, premium, pro]
          description: 구독 등급

    Error:
      type: object
      properties:
        error:
          type: string
        message:
          type: string
        details:
          type: object

    Universe:
      type: object
      properties:
        id:
          type: string
          format: uuid
          description: 세계관 고유 ID
        name:
          type: string
          description: 세계관 이름
        description:
          type: string
          description: 세계관 설명
        representative_image:
          type: string
          format: uri
          description: 세계관 대표 이미지 URL
        estimated_play_time:
          type: integer
          description: 예상 플레이 타임 (분)
        created_at:
          type: string
          format: date-time
          description: 생성일시
        updated_at:
          type: string
          format: date-time
          description: 수정일시

    Character:
      type: object
      properties:
        id:
          type: string
          format: uuid
          description: 캐릭터 고유 ID
        universe_id:
          type: string
          format: uuid
          description: 소속 세계관 ID
        name:
          type: string
          description: 캐릭터 이름
        description:
          type: string
          description: 캐릭터 설명
        avatar_url:
          type: string
          format: uri
          description: 캐릭터 아바타 이미지 URL
        personality:
          type: string
          description: 캐릭터 성격 설정

    Node:
      type: object
      properties:
        id:
          type: string
          format: uuid
          description: 노드 고유 ID
        universe_id:
          type: string
          format: uuid
          description: 소속 세계관 ID
        name:
          type: string
          description: 노드 이름
        description:
          type: string
          description: 노드 설명
        metadata:
          type: object
          description: 노드 메타데이터

    ChatSession:
      type: object
      properties:
        id:
          type: string
          format: uuid
          description: 세션 고유 ID
        user_id:
          type: string
          format: uuid
          description: 사용자 ID
        universe_id:
          type: string
          format: uuid
          description: 세계관 ID
        character_id:
          type: string
          format: uuid
          description: 선택한 캐릭터 ID
        current_node_id:
          type: string
          format: uuid
          nullable: true
          description: 현재 진행 중인 노드 ID
        visited_node_ids:
          type: array
          items:
            type: string
            format: uuid
          description: 방문한 노드 ID 목록
        vector_db_id:
          type: string
          nullable: true
          description: 벡터 DB ID (장기기억)
        chat_history_id:
          type: string
          nullable: true
          description: 채팅 히스토리 ID (단기기억)
        created_at:
          type: string
          format: date-time
          description: 세션 생성일시
        updated_at:
          type: string
          format: date-time
          description: 세션 수정일시

    ChatMessage:
      type: object
      properties:
        id:
          type: string
          format: uuid
          description: 메시지 고유 ID
        session_id:
          type: string
          format: uuid
          description: 세션 ID
        role:
          type: string
          enum: [user, assistant]
          description: 메시지 역할
        content:
          type: string
          description: 메시지 내용
        image_url:
          type: string
          format: uri
          nullable: true
          description: 이미지 URL (assistant 메시지에만 존재)
        audio_url:
          type: string
          format: uri
          nullable: true
          description: TTS 오디오 URL (assistant 메시지에만 존재)
        created_at:
          type: string
          format: date-time
          description: 메시지 생성일시

    ChatResponse:
      type: object
      properties:
        message:
          type: object
          $ref: '#/components/schemas/ChatMessage'
          description: 생성된 메시지
        session:
          type: object
          $ref: '#/components/schemas/ChatSession'
          description: 업데이트된 세션 정보
        image_url:
          type: string
          format: uri
          nullable: true
          description: 생성된 이미지 URL (이미지가 생성된 경우)
        audio_url:
          type: string
          format: uri
          nullable: true
          description: 생성된 TTS 오디오 URL

    UserUpdate:
      type: object
      properties:
        nickname:
          type: string
          maxLength: 30
          description: 닉네임
        avatar_url:
          type: string
          format: uri
          description: 프로필 이미지 URL

    Feedback:
      type: object
      properties:
        id:
          type: string
          format: uuid
          description: 건의사항 고유 ID
        user_id:
          type: string
          format: uuid
          nullable: true
          description: 사용자 ID (로그인한 경우)
        category:
          type: string
          enum: [bug, feature, improvement, other]
          description: 건의사항 카테고리
        title:
          type: string
          description: 제목
        content:
          type: string
          description: 내용
        created_at:
          type: string
          format: date-time
          description: 제출일시

paths:
  /health:
    get:
      tags:
        - System
      summary: 헬스체크
      description: |
        API 서버의 상태를 확인합니다.
        서버가 정상적으로 동작 중인지 확인할 수 있습니다.
      security: []
      responses:
        '200':
          description: 서버 정상 동작
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    enum: [healthy, unhealthy]
                    description: 서버 상태
                    example: "healthy"
                  timestamp:
                    type: string
                    format: date-time
                    description: 응답 시간
                    example: "2024-01-15T10:30:00Z"
                  version:
                    type: string
                    description: API 버전
                    example: "1.0.0"
              example:
                status: "healthy"
                timestamp: "2024-01-15T10:30:00Z"
                version: "1.0.0"
        '503':
          description: 서버 비정상 상태
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "unhealthy"
                  timestamp:
                    type: string
                    format: date-time
                    example: "2024-01-15T10:30:00Z"
                  error:
                    type: string
                    description: 에러 메시지
                    example: "Database connection failed"

  /user/login:
    post:
      tags:
        - User
      summary: 소셜 로그인
      description: |
        소셜 플랫폼(카카오, 네이버, 구글)을 통한 로그인을 수행하고 액세스 토큰을 발급합니다.
        소셜 플랫폼에서 받은 access_token을 전달하면 서버에서 사용자 정보를 조회하고 JWT 토큰을 발급합니다.
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - provider
                - email
                - token
              properties:
                provider:
                  type: string
                  enum: [KAKAO, NAVER, GOOGLE]
                  description: 소셜 로그인 제공자
                  example: KAKAO
                email:
                  type: string
                  format: email
                  description: 사용자 이메일 주소
                  example: "818jsy72@gmail.com"
                token:
                  type: string
                  description: 소셜 플랫폼에서 발급받은 access_token
                  example: "string"
                fcm_token:
                  type: string
                  description: FCM(Firebase Cloud Messaging) 토큰 (푸시 알림용, 선택사항)
                  example: "dXJhbmRvbV9mY21fdG9rZW5fc3RyaW5n"
      responses:
        '200':
          description: 로그인 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  token:
                    type: string
                    description: JWT 액세스 토큰
                  refresh_token:
                    type: string
                    description: JWT 리프레시 토큰
                  expires_in:
                    type: integer
                    description: 토큰 만료 시간 (초)
                    example: 3600
        '400':
          description: 잘못된 요청 (provider, email 또는 token이 유효하지 않음)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: 인증 실패 (소셜 플랫폼에서 인증 실패 또는 유효하지 않은 토큰)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '429':
          description: 너무 많은 로그인 시도
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /user/logout:
    post:
      tags:
        - User
      summary: 로그아웃
      description: |
        현재 로그인한 사용자를 로그아웃 처리합니다.
        JWT 토큰을 무효화하고 FCM 토큰 연결을 해제합니다.
      security:
        - BearerAuth: []
      responses:
        '200':
          description: 로그아웃 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "로그아웃되었습니다"
                  fcm_token_removed:
                    type: boolean
                    description: FCM 토큰 연결 해제 여부
                    example: true
        '401':
          description: 인증되지 않은 사용자
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /user/me:
    get:
      tags:
        - User
      summary: 사용자 프로필 조회
      description: |
        현재 로그인한 사용자의 프로필 정보를 조회합니다.
      security:
        - BearerAuth: []
      responses:
        '200':
          description: 프로필 조회 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
              example:
                id: "550e8400-e29b-41d4-a716-446655440000"
                email: "818jsy72@gmail.com"
                username: "user123"
                nickname: "모험가"
                avatar_url: "https://api.rootale.com/avatars/user123.jpg"
                provider: "KAKAO"
                provider_id: "123456789"
                created_at: "2024-01-01T00:00:00Z"
                updated_at: "2024-01-15T10:00:00Z"
                is_active: true
                subscription_tier: "premium"
        '401':
          description: 인증되지 않은 사용자
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: 사용자를 찾을 수 없음
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    put:
      tags:
        - User
      summary: 사용자 프로필 수정
      description: |
        현재 로그인한 사용자의 프로필 정보를 수정합니다.
        닉네임과 프로필 이미지 URL을 변경할 수 있습니다.
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserUpdate'
            example:
              nickname: "새로운 닉네임"
              avatar_url: "https://api.rootale.com/avatars/new-avatar.jpg"
      responses:
        '200':
          description: 프로필 수정 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
              example:
                id: "550e8400-e29b-41d4-a716-446655440000"
                email: "818jsy72@gmail.com"
                username: "user123"
                nickname: "새로운 닉네임"
                avatar_url: "https://api.rootale.com/avatars/new-avatar.jpg"
                provider: "KAKAO"
                provider_id: "123456789"
                created_at: "2024-01-01T00:00:00Z"
                updated_at: "2024-01-15T10:30:00Z"
                is_active: true
                subscription_tier: "premium"
        '400':
          description: 잘못된 요청 (닉네임 길이 초과 등)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: 인증되지 않은 사용자
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: 사용자를 찾을 수 없음
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /user/refresh:
    post:
      tags:
        - User
      summary: 토큰 갱신
      description: |
        리프레시 토큰을 사용하여 새로운 액세스 토큰과 리프레시 토큰을 발급받습니다.
        액세스 토큰이 만료된 경우 이 API를 호출하여 토큰을 갱신할 수 있습니다.
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - refresh_token
              properties:
                refresh_token:
                  type: string
                  description: 리프레시 토큰
                  example: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
      responses:
        '200':
          description: 토큰 갱신 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  token:
                    type: string
                    description: 새로운 JWT 액세스 토큰
                  refresh_token:
                    type: string
                    description: 새로운 JWT 리프레시 토큰
                  expires_in:
                    type: integer
                    description: 토큰 만료 시간 (초)
                    example: 3600
              example:
                token: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
                refresh_token: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
                expires_in: 3600
        '401':
          description: 인증 실패 (유효하지 않거나 만료된 리프레시 토큰)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '400':
          description: 잘못된 요청 (refresh_token이 제공되지 않음)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /user/withdraw:
    delete:
      tags:
        - User
      summary: 회원 탈퇴
      description: |
        현재 로그인한 사용자의 계정을 탈퇴 처리합니다.
        탈퇴 시 사용자 데이터는 삭제되거나 익명화 처리됩니다.
      security:
        - BearerAuth: []
      responses:
        '200':
          description: 회원 탈퇴 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "회원 탈퇴가 완료되었습니다"
                  deleted_at:
                    type: string
                    format: date-time
                    description: 탈퇴 처리 일시
        '401':
          description: 인증되지 않은 사용자
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: 사용자를 찾을 수 없음
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /universes:
    get:
      tags:
        - Universe
      summary: 세계관 목록 조회
      description: |
        사용 가능한 모든 세계관 목록을 조회합니다.
      security:
        - BearerAuth: []
      responses:
        '200':
          description: 세계관 목록 조회 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  universes:
                    type: array
                    items:
                      $ref: '#/components/schemas/Universe'
        '401':
          description: 인증되지 않은 사용자
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /universes/{universe_id}:
    get:
      tags:
        - Universe
      summary: 세계관 상세 정보 조회
      description: |
        특정 세계관의 상세 정보를 조회합니다.
        세계관 대표 이미지, 설명, 예상 플레이 타임 등의 메타데이터를 포함합니다.
      security:
        - BearerAuth: []
      parameters:
        - name: universe_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: 세계관 고유 ID
      responses:
        '200':
          description: 세계관 정보 조회 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Universe'
        '401':
          description: 인증되지 않은 사용자
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: 세계관을 찾을 수 없음
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /universes/{universe_id}/characters:
    get:
      tags:
        - Universe
      summary: 세계관 캐릭터 목록 조회
      description: |
        특정 세계관에 속한 캐릭터 목록을 조회합니다.
      security:
        - BearerAuth: []
      parameters:
        - name: universe_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: 세계관 고유 ID
      responses:
        '200':
          description: 캐릭터 목록 조회 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  characters:
                    type: array
                    items:
                      $ref: '#/components/schemas/Character'
        '401':
          description: 인증되지 않은 사용자
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: 세계관을 찾을 수 없음
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /session:
    post:
      tags:
        - Session
      summary: 세계관 초기화 및 세션 생성
      description: |
        세계관을 선택하고 초기화합니다.
        서버에서 세계관 노드 전체를 캐싱하고, 메타데이터를 로드하며,
        유저별 세계관 설정을 로드합니다.
        첫 채팅인 경우 세계관 초기 메시지와 이미지를 생성합니다.
        세션을 생성하고 첫 대사와 첫 사진을 반환합니다.
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - universe_id
                - character_id
              properties:
                universe_id:
                  type: string
                  format: uuid
                  description: 세계관 고유 ID
                  example: "550e8400-e29b-41d4-a716-446655440000"
                character_id:
                  type: string
                  format: uuid
                  description: 선택한 캐릭터 ID
                  example: "550e8400-e29b-41d4-a716-446655440000"
      responses:
        '201':
          description: 세계관 초기화 및 세션 생성 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  first_message:
                    type: string
                    description: 첫 대사 (초기 메시지 내용)
                    example: "안녕하세요! 저는 당신의 안내자가 될 캐릭터입니다."
                  first_image:
                    type: string
                    format: uri
                    description: 첫 사진 (초기 메시지 이미지 URL)
                    example: "https://api.rootale.com/images/initial-scene.jpg"
        '400':
          description: 잘못된 요청 (universe_id 또는 character_id가 유효하지 않음)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: 인증되지 않은 사용자
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: 세계관 또는 캐릭터를 찾을 수 없음
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    get:
      tags:
        - Session
      summary: 전체 내러티브 세션 조회
      description: |
        현재 사용자의 모든 내러티브 세션 목록을 조회합니다.
      security:
        - BearerAuth: []
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 50
          description: 조회할 세션 개수
        - name: offset
          in: query
          schema:
            type: integer
            minimum: 0
            default: 0
          description: 조회 시작 위치
      responses:
        '200':
          description: 세션 목록 조회 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  sessions:
                    type: array
                    items:
                      type: object
                      properties:
                        session_id:
                          type: string
                          format: uuid
                          description: 세션 ID
                        session_name:
                          type: string
                          description: 세션 이름
                        universe_id:
                          type: string
                          format: uuid
                          description: 유니버스 ID
                        representative_image:
                          type: string
                          format: uri
                          description: 대표 이미지 URL
                        created_at:
                          type: string
                          format: date-time
                          description: 세션 생성일시
                        updated_at:
                          type: string
                          format: date-time
                          description: 세션 수정일시
                  total:
                    type: integer
                    description: 전체 세션 개수
                    example: 10
              example:
                sessions:
                  - session_id: "550e8400-e29b-41d4-a716-446655440000"
                    session_name: "모험의 시작"
                    universe_id: "550e8400-e29b-41d4-a716-446655440010"
                    representative_image: "https://api.rootale.com/images/session-1.jpg"
                    created_at: "2024-01-15T10:00:00Z"
                    updated_at: "2024-01-15T10:30:00Z"
                  - session_id: "550e8400-e29b-41d4-a716-446655440001"
                    session_name: "마법의 숲"
                    universe_id: "550e8400-e29b-41d4-a716-446655440011"
                    representative_image: "https://api.rootale.com/images/session-2.jpg"
                    created_at: "2024-01-14T15:20:00Z"
                    updated_at: "2024-01-14T16:45:00Z"
                total: 10
        '401':
          description: 인증되지 않은 사용자
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /session/{session_id}:
    delete:
      tags:
        - Session
      summary: 세션 삭제
      description: |
        특정 내러티브 세션을 삭제합니다.
        세션과 관련된 모든 데이터(메시지, 히스토리 등)가 함께 삭제됩니다.
      security:
        - BearerAuth: []
      parameters:
        - name: session_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: 세션 고유 ID
      responses:
        '200':
          description: 세션 삭제 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "세션이 삭제되었습니다"
        '401':
          description: 인증되지 않은 사용자
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: 다른 사용자의 세션에 접근할 수 없음
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: 세션을 찾을 수 없음
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /narrative/callback/text/{callback_id}:
    get:
      tags:
        - Narrative
      summary: 텍스트 생성 상태 확인
      description: |
        텍스트 생성 상태를 확인하고, 준비된 경우 텍스트를 반환합니다.
        텍스트가 아직 생성 중인 경우 상태를 반환하고, 생성이 완료되면 텍스트를 반환합니다.
      security:
        - BearerAuth: []
      parameters:
        - name: callback_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: 콜백 ID (text_callback_url에서 추출)
          example: "550e8400-e29b-41d4-a716-446655440000"
      responses:
        '200':
          description: 텍스트 생성 상태 확인 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    enum: [pending, completed, failed]
                    description: 텍스트 생성 상태 (pending - 생성 중, completed - 완료, failed - 실패)
                    example: "completed"
                  text:
                    type: string
                    nullable: true
                    description: 생성된 텍스트 (status가 completed인 경우에만 포함)
                    example: "안녕하세요! 오늘 날씨가 정말 좋네요."
                  error:
                    type: string
                    nullable: true
                    description: 에러 메시지 (status가 failed인 경우에만 포함)
        '401':
          description: 인증되지 않은 사용자
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: 콜백 ID를 찾을 수 없음
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /narrative/callback/image/{callback_id}:
    get:
      tags:
        - Narrative
      summary: 이미지 생성 상태 확인
      description: |
        이미지 생성 상태를 확인하고, 준비된 경우 이미지 URL을 반환합니다.
        이미지가 아직 생성 중인 경우 상태를 반환하고, 생성이 완료되면 이미지 URL을 반환합니다.
      security:
        - BearerAuth: []
      parameters:
        - name: callback_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: 콜백 ID (image_callback_url에서 추출)
          example: "550e8400-e29b-41d4-a716-446655440000"
      responses:
        '200':
          description: 이미지 생성 상태 확인 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    enum: [pending, completed, failed]
                    description: 이미지 생성 상태 (pending - 생성 중, completed - 완료, failed - 실패)
                    example: "completed"
                  image_url:
                    type: string
                    format: uri
                    nullable: true
                    description: 생성된 이미지 URL (status가 completed인 경우에만 포함)
                    example: "https://api.rootale.com/images/generated-12345.jpg"
                  error:
                    type: string
                    nullable: true
                    description: 에러 메시지 (status가 failed인 경우에만 포함)
        '401':
          description: 인증되지 않은 사용자
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: 콜백 ID를 찾을 수 없음
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /narrative/{session_id}/tts:
    post:
      tags:
        - Narrative
      summary: TTS 오디오 생성
      description: |
        특정 세션의 최신 메시지 또는 지정된 텍스트를 TTS로 변환하여 오디오를 생성합니다.
        서버에서 TTS CPU 처리를 수행하여 오디오 파일을 생성하고 URL을 반환합니다.
      security:
        - BearerAuth: []
      parameters:
        - name: session_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: 세션 고유 ID
          example: "550e8400-e29b-41d4-a716-446655440000"
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                message_id:
                  type: string
                  format: uuid
                  description: TTS로 변환할 메시지 ID (지정하지 않으면 최신 메시지 사용)
                  example: "550e8400-e29b-41d4-a716-446655440000"
                text:
                  type: string
                  description: TTS로 변환할 텍스트 (message_id가 없을 경우 사용)
                  example: "안녕하세요! 오늘 날씨가 정말 좋네요."
                voice_type:
                  type: string
                  description: 성우 종류 (지정하지 않으면 기본 성우 사용)
                  enum: [male, female, neutral]
                  example: "female"
      responses:
        '200':
          description: TTS 오디오 생성 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  audio_url:
                    type: string
                    format: uri
                    description: 생성된 TTS 오디오 URL
                    example: "https://api.rootale.com/audio/tts-12345.mp3"
                  message_id:
                    type: string
                    format: uuid
                    nullable: true
                    description: TTS로 변환된 메시지 ID (message_id를 지정한 경우)
        '400':
          description: 잘못된 요청 (message_id 또는 text가 유효하지 않음)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: 인증되지 않은 사용자
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: 다른 사용자의 세션에 접근할 수 없음
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: 세션 또는 메시지를 찾을 수 없음
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: 서버 내부 오류 (TTS 처리 실패 등)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /narrative/{session_id}/messages:
    post:
      tags:
        - Narrative
      summary: 메시지 전송 및 응답 생성
      description: |
        유저 메시지를 전송하고 AI 응답을 생성합니다.
        
        **서버 처리 과정:**
        1. 유저 메시지와 세션 컨텍스트(선택한 캐릭터, 진행 중인 노드, 방문한 노드)를 수집
        2. 벡터 임베딩 주입: User Universe Attribute와 벡터 DB에서 관련 장기기억을 검색하여 컨텍스트 구성
        3. Gemini API 호출: 구성된 컨텍스트와 유저 메시지를 Gemini에 전달하여 응답 생성
        4. Gemini 출력을 분석하여 필요시 이미지 API 호출 (서버에서 자동 처리, 비동기)
        5. 해당 턴의 User/Assistant 대화를 벡터 임베딩하여 벡터 DB에 저장 (장기기억 업데이트)
        6. 채팅 히스토리 업데이트 (단기기억 업데이트)
        7. 생성된 텍스트와 이미지 콜백 URL을 클라이언트에 반환
        
        **비동기 처리 (폴링 방식):**
        - 텍스트와 이미지는 각각 독립적으로 생성되며, 어느 것이 먼저 도착할지 보장되지 않습니다.
        - 텍스트가 먼저 준비되면 즉시 응답에 포함됩니다.
        - 텍스트가 생성 중인 경우, `text_callback_url`이 응답에 포함됩니다. 클라이언트는 이 URL을 주기적으로 폴링하여 텍스트 생성 상태를 확인합니다.
        - 이미지가 생성 중인 경우, `image_callback_url`이 응답에 포함됩니다. 클라이언트는 이 URL을 주기적으로 폴링하여 이미지 생성 상태를 확인합니다.
        - 폴링은 GET 요청으로 수행하며, 상태가 `pending`인 경우 계속 폴링하고, `completed` 또는 `failed`인 경우 폴링을 중지합니다.
        
        **참고:** 벡터 임베딩은 현재는 Gemini 입력/출력을 유저별 로그로 저장하는 수준으로 구현되며,
        향후 Chat 담당자가 벡터 임베딩 기능을 구현할 예정입니다.
      security:
        - BearerAuth: []
      parameters:
        - name: session_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: 세션 고유 ID
          example: "550e8400-e29b-41d4-a716-446655440000"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - message
              properties:
                message:
                  type: string
                  description: 유저 메시지 내용
                  example: "안녕하세요! 오늘 날씨가 정말 좋네요."
      responses:
        '200':
          description: 메시지 전송 및 응답 생성 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  text:
                    type: string
                    nullable: true
                    description: 생성된 텍스트 응답 (텍스트가 준비된 경우에만 포함)
                    example: "안녕하세요! 오늘 날씨가 정말 좋네요."
                  text_callback_url:
                    type: string
                    format: uri
                    nullable: true
                    description: 텍스트 생성 상태 확인용 URL (텍스트가 생성 중인 경우에만 포함, 폴링 방식으로 상태 확인)
                    example: "https://api.rootale.com/v1/narrative/callback/text/550e8400-e29b-41d4-a716-446655440000"
                  image_callback_url:
                    type: string
                    format: uri
                    nullable: true
                    description: 이미지 생성 상태 확인용 URL (이미지가 생성 중인 경우에만 포함, 폴링 방식으로 상태 확인)
                    example: "https://api.rootale.com/v1/narrative/callback/image/550e8400-e29b-41d4-a716-446655440000"
        '400':
          description: 잘못된 요청 (message가 유효하지 않음)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: 인증되지 않은 사용자
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: 다른 사용자의 세션에 접근할 수 없음
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: 세션을 찾을 수 없음
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '429':
          description: 너무 많은 요청 (Rate limit 초과)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: 서버 내부 오류 (Gemini API 또는 이미지 API 호출 실패 등)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /narrative/{session_id}/history:
    get:
      tags:
        - Narrative
      summary: 세션 메시지 히스토리 조회
      description: |
        특정 세션의 내러티브 메시지 히스토리를 조회합니다.
        단기기억에 저장된 대화 내역을 반환합니다.
      security:
        - BearerAuth: []
      parameters:
        - name: session_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: 세션 고유 ID
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 50
          description: 조회할 메시지 개수
        - name: offset
          in: query
          schema:
            type: integer
            minimum: 0
            default: 0
          description: 조회 시작 위치
      responses:
        '200':
          description: 메시지 히스토리 조회 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  messages:
                    type: array
                    items:
                      $ref: '#/components/schemas/ChatMessage'
                  total:
                    type: integer
                    description: 전체 메시지 개수
                    example: 25
              example:
                messages:
                  - id: "550e8400-e29b-41d4-a716-446655440001"
                    session_id: "550e8400-e29b-41d4-a716-446655440000"
                    role: "user"
                    content: "안녕하세요! 오늘 날씨가 정말 좋네요."
                    image_url: null
                    audio_url: null
                    created_at: "2024-01-15T10:30:00Z"
                  - id: "550e8400-e29b-41d4-a716-446655440002"
                    session_id: "550e8400-e29b-41d4-a716-446655440000"
                    role: "assistant"
                    content: "안녕하세요! 맞아요, 오늘 날씨가 정말 화창하네요. 산책하기 좋은 날씨예요."
                    image_url: "https://api.rootale.com/images/generated-12345.jpg"
                    audio_url: "https://api.rootale.com/audio/tts-12345.mp3"
                    created_at: "2024-01-15T10:30:05Z"
                  - id: "550e8400-e29b-41d4-a716-446655440003"
                    session_id: "550e8400-e29b-41d4-a716-446655440000"
                    role: "user"
                    content: "그럼 같이 산책하러 가볼까요?"
                    image_url: null
                    audio_url: null
                    created_at: "2024-01-15T10:31:00Z"
                total: 25
        '401':
          description: 인증되지 않은 사용자
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: 다른 사용자의 세션에 접근할 수 없음
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: 세션을 찾을 수 없음
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /feedback:
    post:
      tags:
        - System
      summary: 건의사항 제출
      description: |
        버그 리포트, 기능 제안, 개선 사항 등의 건의사항을 제출합니다.
        로그인한 사용자는 자동으로 사용자 ID가 연결되며, 비로그인 사용자도 제출할 수 있습니다.
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - category
                - title
                - content
              properties:
                category:
                  type: string
                  enum: [bug, feature, improvement, other]
                  description: 건의사항 카테고리
                  example: "bug"
                title:
                  type: string
                  minLength: 1
                  maxLength: 200
                  description: 제목
                  example: "로그인 시 오류 발생"
                content:
                  type: string
                  minLength: 1
                  maxLength: 5000
                  description: 내용
                  example: "카카오 로그인 시 간헐적으로 500 에러가 발생합니다."
      responses:
        '201':
          description: 건의사항 제출 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Feedback'
              example:
                id: "550e8400-e29b-41d4-a716-446655440000"
                user_id: "550e8400-e29b-41d4-a716-446655440001"
                category: "bug"
                title: "로그인 시 오류 발생"
                content: "카카오 로그인 시 간헐적으로 500 에러가 발생합니다."
                created_at: "2024-01-15T10:30:00Z"
        '400':
          description: 잘못된 요청 (필수 필드 누락 또는 유효하지 않은 값)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '429':
          description: 너무 많은 요청 (Rate limit 초과)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
